/*! pipeline - v0.0.0 - 2014-07-15
* Copyright (c) 2014 Plarium; Licensed MIT */
window.Pipeline=function(){function a(a){return Math.floor(a/l)}function b(a){return new Date(a*l)}function c(a,b,c){var d;return function(){var e=this,f=arguments;clearTimeout(d),d=setTimeout(function(){d=null,c||a.apply(e,f)},b),c&&!d&&a.apply(e,f)}}function d(){return(0|new Date).toString(16)+(1e9*Math.random()|0).toString(16)}function e(){this.firstStop=null,this._stopsByDay={},this._stopsByGuid={}}function f(a){this.value=a,this.next=null,this.prev=null,this.guid=d()}function g(a,b){this.masterView=a,this.element=b}function h(){this.$=this.render()}function i(){this._onStopMarkerClick=this._onStopMarkerClick.bind(this),this._onStopMarkerMouseDown=this._onStopMarkerMouseDown.bind(this),this._onIntervalClick=this._onIntervalClick.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onRootScroll=c(this._onRootScroll.bind(this),C),this._onAddStop=this._onAddStop.bind(this),this._onRemoveStop=this._onRemoveStop.bind(this),this._onChangeStopDay=this._onChangeStopDay.bind(this),this._onBoundsChange=this._onBoundsChange.bind(this),this._state=n,this._stopMarkersByGuid=[],this.model=new e,this.render(),this.model.syncBounds(),this._initListeners(),this.setZoom(7)}function j(a){if(!a)throw new Error("no options");if(!a.guid)throw new Error("no guid");this.$=this.render(),this.$.attr("guid",this.guid=a.guid)}function k(){}var l=864e5,m=a(new Date(2e3,0,0)),n="idle",o="wait",p="dragging",q="ppl-root",r="ppl-stop-marker",s="ppl-tick-marker",t="ppl-interval",u="ppl-interval-container",v="ppl-stop-container",w="ppl-ruler-container",x="ppl-wrapper",y=128,z=7,A=5,B=200,C=300,D=function(){};D.prototype={bind:function(a,b){this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{},a in this._events!=!1&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){if(this._events=this._events||{},a in this._events!=!1)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}},D.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)"function"==typeof a?a.prototype[b[c]]=D.prototype[b[c]]:a[b[c]]=D.prototype[b[c]]},e.prototype.addStop=function(a){if(this.stopByDay(a))throw new Error("day exists");var b=this.findPreviousStop(a),c=new f(a);this._insertStopAfter(c,b),this._registerStop(c),this.syncBounds(),this.trigger("addStop",c)},e.prototype._registerStop=function(a){this._stopsByDay[a.value]=a,this._stopsByGuid[a.guid]=a},e.prototype._unregisterStop=function(a){delete this._stopsByDay[a.value],delete this._stopsByGuid[a.guid]},e.prototype.stopByDay=function(a){return this._stopsByDay[a]||null},e.prototype.stopByGuid=function(a){return this._stopsByGuid[a]||null},e.prototype.removeStop=function(a){var b=a.next,c=a.prev;b&&(b.prev=c),c?c.next=b:this.firstStop=b,a===this.lastStop&&(this.lastStop=a.prev),a.prev=null,a.next=null,this.syncBounds(),this.trigger("removeStop",a),this._unregisterStop(a)},e.prototype._getLowerBound=function(){return this.firstStop?this.firstStop.value:10955},e.prototype._getHigherBound=function(){return this.lastStop?this.lastStop.value:18255},e.prototype.syncBounds=function(){var a=this._getLowerBound(),b=!1;a!==this.lowerBound&&(this.lowerBound=a,b=!0);var c=this._getHigherBound();c!==this.higherBound&&(this.higherBound=c,b=!0),b&&this.trigger("boundsChange")},e.prototype.changeStopDay=function(a,b){if(b=0|b,b!==a.value){var c=a.prev;if(c&&b<=c.value)throw new RangeError("lower bound");var d=a.next;if(d&&b>=d.value)throw new RangeError("higher bound");delete this._stopsByDay[a.value],a.value=b,this._stopsByDay[b]=a,this.syncBounds(),this.trigger("changeStopDay",a)}},e.prototype._insertStopAfter=function(a,b){if(!b)return this.firstStop&&(this.firstStop.prev=a,a.next=this.firstStop),this.firstStop=a,void(this.lastStop=a);var c=b.next;c&&(c.prev=a),b.next=a,a.prev=b,a.next=c,b===this.lastStop&&(this.lastStop=a)},e.prototype.findPreviousStop=function(a){for(var b=this.firstStop;b;){if(!b.next&&b.value<a)return b;if(b.value>a)return b.prev;b=b.next}return b},D.mixin(e);var E=[{unit:"year5"},{unit:"year"},{unit:"year"},{unit:"quarter"},{unit:"quarter"},{unit:"month"},{unit:"month"},{unit:"decade"}],F={year5:function(a){return a.getYear()%5===0&&0===a.getMonth()&&1===a.getDate()},year:function(a){return 0===a.getMonth()&&1===a.getDate()},quarter:function(a){var b=a.getMonth();return 1===a.getDate()&&b%4===0},month:function(a){return 1===a.getDate()},decade:function(a){var b=a.getDate();return 1===b||11===b||21===b}};return g.prototype.update=function(a,c){console.time("a"),this.element.children().remove(),this.ticks=[];for(var d,e=this.masterView.getZoom(),f=E[e].unit,g=F[f],h=a;c>=h;h++){var d=b(h);g(d)&&this.addTick(h)}console.timeEnd("a")},g.prototype.addTick=function(a){var b=new h;b.render(),b.setOffset(this.masterView.dayToOffset(a)),this.element.append(b.$)},h.prototype.render=function(){return $('<div class="'+s+'">')},h.prototype.setOffset=function(a){this.offset=a,this.$.css("left",a)},h.prototype.getOffset=function(){return this.offset},i.prototype.render=function(){if(this.$)return this.$.root;this.$={};var a=this._renderRoot(),b=this.$.wrapper=this._renderWrapper(),c=this.$.stopContainer=this._renderStopContainer(),d=this.$.intervalContainer=this._renderIntervalContainer(),e=this.$.rulerContainer=this._renderRulerContainer();return this.ruler=new g(this,e),a.append(b),b.append(e),b.append(d),b.append(c),this.$.root=a,setTimeout(this._updateViewportInfo.bind(this),100),a},i.prototype._renderRoot=function(){return $('<div class="'+q+'">')},i.prototype._renderStopContainer=function(){return $('<div class="'+v+'">')},i.prototype._renderWrapper=function(){return $('<div class="'+x+'">')},i.prototype._renderIntervalContainer=function(){return $('<div class="'+u+'">')},i.prototype._renderRulerContainer=function(){return $('<div class="'+w+'">')},i.prototype.selectStop=function(a){this._selectedStop&&this._stopMarkerByStop(this._selectedStop).setSelected(!1),this._selectedStop=a,this._stopMarkerByStop(a).setSelected(!0)},i.prototype.getZoom=function(){return this._z},i.prototype.setZoom=function(a){if(0>a||a>z)throw new RangeError("zoom");this._z=a,this._pixelsADay=Math.pow(2,a)*A/y,this._updateViewportInfo()},i.prototype.zoomPlus=function(){var a=this.getZoom();z>a&&this.setZoom(a+1)},i.prototype.zoomMinus=function(){var a=this.getZoom();a>0&&this.setZoom(a-1)},i.prototype.offsetToDay=function(a){var b=a/this._pixelsADay,c=b+m;return 0|c},i.prototype.dayToOffset=function(a){var b=a-m,c=this._pixelsADay*b;return 0|c},i.prototype.setStateDragging=function(){console.log("STATE_DRAGGING"),this._state=p,this._stopMarkerByStop(this._selectedStop).setDragging(!0);var a=this._selectedStop.prev,b=this._selectedStop.next;this._dragMinOffset=null,this._dragMaxOffset=null,a&&(this._dragMinOffset=this.dayToOffset(a.value+1)),b&&(this._dragMaxOffset=this.dayToOffset(b.value-1))},i.prototype.isStateDragging=function(){return this._state===p},i.prototype.setStateIdle=function(){console.log("STATE_IDLE"),this._state=n},i.prototype.isStateIdle=function(){return this._state===n},i.prototype.setStateWaitDrag=function(){console.log("STATE_WAIT_DRAG"),this._state=o,this._waitDragTimer=setTimeout(this._onWaitDragTimeout.bind(this),B)},i.prototype.isStateWaitDrag=function(){return this._state===o},i.prototype._updateViewportInfo=function(){var a=this.$.root[0].scrollLeft,b=this.$.root[0].clientWidth,c=a+b,d=this.offsetToDay(a),e=this.offsetToDay(c);this.dayStart=d,this.dayEnd=e,this._updateRuler()},i.prototype._updateRuler=function(){this.ruler.update(this.dayStart,this.dayEnd)},i.prototype._initListeners=function(){var a=this.$.root,b=$("body");a.on("click","."+r,this._onStopMarkerClick),a.on("click","."+t,this._onIntervalClick),a.on("mousedown","."+r,this._onStopMarkerMouseDown),a.on("scroll",this._onRootScroll),b.on("mouseup",this._onMouseUp),b.on("mousemove",this._onMouseMove),this.model.bind("addStop",this._onAddStop),this.model.bind("removeStop",this._onRemoveStop),this.model.bind("changeStopDay",this._onChangeStopDay),this.model.bind("boundsChange",this._onBoundsChange)},i.prototype._onWaitDragTimeout=function(){this.setStateDragging()},i.prototype._stopFromEvent=function(a){var b=$(a.target).attr("guid");if(!b)throw new Error("no guid in event.target");var c=this.model.stopByGuid(b);if(!c)throw new Error("stop not found");return c},i.prototype._onStopMarkerClick=function(a){this._stopFromEvent(a)},i.prototype._onStopMarkerMouseDown=function(a){a.preventDefault();var b=this._stopFromEvent(a);return this.selectStop(b),this.isStateIdle()?void this.setStateWaitDrag():void 0},i.prototype._onRootScroll=function(){this._updateViewportInfo()},i.prototype._onIntervalClick=function(){},i.prototype._onMouseUp=function(){return this.isStateWaitDrag()?(clearTimeout(this._waitDragTimer),void this.setStateIdle()):this.isStateDragging()?(this._onDrop(this._selectedStop),void this.setStateIdle()):void 0},i.prototype._onDrop=function(a){var b=this._stopMarkerByStop(a);b.setDragging(!1);var c=b.getOffset(),d=this.offsetToDay(c);try{this.model.changeStopDay(a,d)}catch(e){b.setOffset(this.dayToOffset(a.value))}},i.prototype._localOffsetFromEvent=function(a){var b=this.$.root,c=b[0].getBoundingClientRect(),d=c.left,e=a.clientX,f=b[0].scrollLeft;return e-d+f},i.prototype._onMouseMove=function(a){if(this.isStateDragging()){var b=this._localOffsetFromEvent(a);return b=this.dayToOffset(this.offsetToDay(b)),null!==this._dragMaxOffset&&b>=this._dragMaxOffset&&(b=this._dragMaxOffset),null!==this._dragMinOffset&&b<=this._dragMinOffset&&(b=this._dragMinOffset),void this._stopMarkerByStop(this._selectedStop).setOffset(b)}},i.prototype._onAddStop=function(a){this._addStopMarker(a)},i.prototype._onRemoveStop=function(){},i.prototype._onBoundsChange=function(){this.setBounds(this.model.lowerBound,this.model.higherBound)},i.prototype.setBounds=function(a,b){var c=this.dayToOffset(b),d=this.dayToOffset(a);console.log("lowerOffset",d),console.log("higherOffset",c)},i.prototype._onChangeStopDay=function(a){var b=this.dayToOffset(a.value),c=this._stopMarkerByStop(a);c.setOffset(b)},i.prototype._addStopMarker=function(a){var b=a.value,c=this.dayToOffset(b),d=new j({guid:a.guid});d.setOffset(c),this.$.stopContainer.append(d.$),this._registerStopMarker(d,a)},i.prototype._stopMarkerByStop=function(a){return this._stopMarkersByGuid[a.guid]},i.prototype._registerStopMarker=function(a,b){this._stopMarkersByGuid[b.guid]=a},i.prototype._unregisterStopMarker=function(a){delete this._stopMarkersByGuid[a.guid]},i.prototype.destroy=function(){this.$.off("click"),this.$.off("mousedown"),this.$.off("mouseup"),this.$.off("mousemove")},j.prototype.render=function(){return $('<div class="'+r+'">')},j.prototype.setOffset=function(a){this.offset=a,this.$.css("left",a)},j.prototype.getOffset=function(){return this.offset},j.prototype.setSelected=function(a){a&&this.$.addClass("active")||this.$.removeClass("active")},j.prototype.setDragging=function(a){a&&this.$.addClass("dragging")||this.$.removeClass("dragging")},k.prototype.render=function(){return $('<div class="'+t+'">')},i}();