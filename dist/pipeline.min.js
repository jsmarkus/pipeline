/*! pipeline - v0.0.0 - 2014-07-28
* Copyright (c) 2014 Plarium; Licensed MIT */
window.Pipeline=function(){function a(a){return Math.floor(a/n)}function b(a){return new Date(a*n)}function c(a,b,c){var d;return function(){var e=this,f=arguments;clearTimeout(d),d=setTimeout(function(){d=null,c||a.apply(e,f)},b),c&&!d&&a.apply(e,f)}}function d(){return(0|new Date).toString(16)+(1e9*Math.random()|0).toString(16)}function e(){this.firstStop=null,this._stopsByDay={},this._stopsByGuid={},this._intervalsByGuid={},this._attachInterval(this._createInterval(),null,null)}function f(a){this.value=a,this.next=null,this.prev=null,this.guid=d()}function g(a,b){this.from=a,this.to=b,this.guid=d()}function h(a,b){this.masterView=a,this.element=b}function i(){}function j(){this._onStopContainerDoubleClick=this._onStopContainerDoubleClick.bind(this),this._onStopMarkerMouseDown=this._onStopMarkerMouseDown.bind(this),this._onStopMarkerDoubleClick=this._onStopMarkerDoubleClick.bind(this),this._onIntervalClick=this._onIntervalClick.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onRootScroll=c(this._onRootScroll.bind(this),L),this._onAddStop=this._onAddStop.bind(this),this._onRemoveStop=this._onRemoveStop.bind(this),this._onChangeStopDay=this._onChangeStopDay.bind(this),this._onBoundsChange=this._onBoundsChange.bind(this),this._onChangeInterval=this._onChangeInterval.bind(this),this._onRemoveInterval=this._onRemoveInterval.bind(this),this._state=p,this._stopMarkersByGuid={},this._intervalMarkersByGuid={},this._fmt={},this.setFormatters(m),this.model=new e,this.render(),this.model.syncBounds(),this._initListeners(),this.setZoom(7)}function k(a){if(!a)throw new Error("no options");if(!a.guid)throw new Error("no guid");this.$=this.render(),this.$.attr("guid",this.guid=a.guid)}function l(a){if(!a)throw new Error("no options");if(!a.guid)throw new Error("no guid");this.$=this.render(),this.$.attr("guid",this.guid=a.guid)}var m=function(){var a={};return a.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a.tick_year5=function(a){return a.getFullYear()},a.tick_year=function(a){return a.getFullYear()},a.tick_quarter=function(a){var b=a.getMonth(),c=[this.getMonthName(a)];return 0===b&&c.push(a.getFullYear()),c.join("<br>")},a.tick_month=function(a){var b=a.getMonth(),c=[this.getMonthName(a)];return 0===b&&c.push(a.getFullYear()),c.join("<br>")},a.tick_decade=function(a){var b=a.getMonth(),c=a.getDate(),d=[c];return 1===c&&(d.push(this.getMonthName(a)),0===b&&d.push(a.getFullYear())),d.join("<br>")},a.getMonthName=function(a){return this.months[a.getMonth()]},a.tickLabel=function(a,b,c){var d="tick_"+c;return this[d](b)},a.stopLabel=function(a,b){var c=b.getFullYear(),d=b.getDate(),e=this.getMonthName(b);return[d,e,c].join("<br />")},a}(),n=864e5,o=a(new Date(2e3,0,0)),p="idle",q="wait",r="dragging",s="ppl-root ppl-root-scrollbody",t="ppl-stop",u="ppl-stop-date",v="ppl-stop-line",w="ppl-ruler-tick base",x="base-item",y="ppl-interval",z="ppl-interval-container",A="ppl-stop-container",B="ppl-ruler",C="ppl-root-wrapper",D="ppl-hair",E="draggable",F="active",G=128,H=7,I=5,J=150,K=200,L=300,M=200,N=function(){};N.prototype={bind:function(a,b){this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{},a in this._events!=!1&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){if(this._events=this._events||{},a in this._events!=!1)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}},N.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)"function"==typeof a?a.prototype[b[c]]=N.prototype[b[c]]:a[b[c]]=N.prototype[b[c]]},e.prototype._createInterval=function(a,b){var c=new g(a,b);return this._registerInterval(c),c},e.prototype.addStop=function(a){if(this.stopByDay(a))throw new Error("day exists");var b=this.findPreviousStop(a),c=new f(a);this._insertStopAfter(c,b),this._registerStop(c),this.syncBounds(),this.trigger("addStop",c),this._splitInterval(c)},e.prototype._detachInterval=function(a){a.from&&(a.from.nextInterval=null,a.from=null),a.to&&(a.to.prevInterval=null,a.to=null),a===this._startInterval&&(this._startInterval=null)},e.prototype._attachInterval=function(a,b,c){if(b)b.nextInterval=a;else{if(this._startInterval)throw new Error("cannot attach starting interval twice");this._startInterval=a}c&&(c.prevInterval=a),a.from=b,a.to=c,this.trigger("changeInterval",a)},e.prototype._joinIntervals=function(a){var b=a.prevInterval,c=a.nextInterval,d=b.from,e=c.to;this._detachInterval(c),this.trigger("removeInterval",c),this._unregisterInterval(c),this._detachInterval(b),this._attachInterval(b,d,e)},e.prototype._splitInterval=function(a){var b=a.prev,c=a.next,d=b?b.nextInterval:this._startInterval;if(!d)throw new Error("integrity error: interval not found");this._detachInterval(d);var e=this._createInterval(a,c);this._attachInterval(e,a,c),this._attachInterval(d,b,a)},e.prototype.getBoundingInterval=function(a){var b,c=this.findPreviousStop(a);if(b=c?c.nextInterval:this._startInterval,!b)throw new Error("integrity error: interval not found");return b},e.prototype._registerStop=function(a){this._stopsByDay[a.value]=a,this._stopsByGuid[a.guid]=a},e.prototype._registerInterval=function(a){this._intervalsByGuid[a.guid]=a},e.prototype._unregisterInterval=function(a){delete this._intervalsByGuid[a.guid]},e.prototype._unregisterStop=function(a){delete this._stopsByDay[a.value],delete this._stopsByGuid[a.guid]},e.prototype.stopByDay=function(a){return this._stopsByDay[a]||null},e.prototype.stopByGuid=function(a){return this._stopsByGuid[a]||null},e.prototype.intervalByGuid=function(a){return this._intervalsByGuid[a]||null},e.prototype.removeStop=function(a){var b=a.next,c=a.prev;this._joinIntervals(a),b&&(b.prev=c),c?c.next=b:this.firstStop=b,a===this.lastStop&&(this.lastStop=a.prev),a.prev=null,a.next=null,this.syncBounds(),this.trigger("removeStop",a),this._unregisterStop(a)},e.prototype._getLowerBound=function(){return this.firstStop?this.firstStop.value:10955},e.prototype._getHigherBound=function(){return this.lastStop?this.lastStop.value:18255},e.prototype.syncBounds=function(){var a=this._getLowerBound(),b=!1;a!==this.lowerBound&&(this.lowerBound=a,b=!0);var c=this._getHigherBound();c!==this.higherBound&&(this.higherBound=c,b=!0),b&&this.trigger("boundsChange")},e.prototype.changeStopDay=function(a,b){if(b=0|b,b!==a.value){var c=a.prev;if(c&&b<=c.value)throw new RangeError("lower bound");var d=a.next;if(d&&b>=d.value)throw new RangeError("higher bound");delete this._stopsByDay[a.value],a.value=b,this._stopsByDay[b]=a,this.syncBounds(),this.trigger("changeStopDay",a)}},e.prototype._insertStopAfter=function(a,b){if(!b)return this.firstStop&&(this.firstStop.prev=a,a.next=this.firstStop),this.firstStop=a,void(this.lastStop=a);var c=b.next;c&&(c.prev=a),b.next=a,a.prev=b,a.next=c,b===this.lastStop&&(this.lastStop=a)},e.prototype.findPreviousStop=function(a){for(var b=this.firstStop;b;){if(!b.next&&b.value<a)return b;if(b.value>a)return b.prev;b=b.next}return b},N.mixin(e);var O=[{unit:"year5"},{unit:"year"},{unit:"year"},{unit:"quarter"},{unit:"quarter"},{unit:"month"},{unit:"month"},{unit:"decade"}],P={year5:function(a){return a.getYear()%5===0&&0===a.getMonth()&&1===a.getDate()},year:function(a){return 0===a.getMonth()&&1===a.getDate()},quarter:function(a){var b=a.getMonth();return 1===a.getDate()&&b%4===0},month:function(a){return 1===a.getDate()},decade:function(a){var b=a.getDate();return 1===b||11===b||21===b}};return h.prototype.update=function(a,c){console.time("a"),this.element.children().remove(),this.ticks=[];for(var d,e=this.masterView.getZoom(),f=O[e].unit,g=P[f],h=a;c>=h;h++)d=b(h),g(d)&&this.addTick(h,f);console.timeEnd("a")},h.prototype.addTick=function(a,c){var d=new i;d.render(),d.setOffset(this.masterView.dayToOffset(a)),d.setContent(this.masterView._fmt.tickLabel(a,b(a),c)),this.element.append(d.$)},i.prototype.render=function(){var a=$('<div class="'+w+'">'),b=$('<div class="'+x+'">');b.appendTo(a),this.$content=b,this.$=a},i.prototype.setOffset=function(a){this.offset=a,this.$.css("left",a)},i.prototype.setContent=function(a){this.$content.html(a)},i.prototype.getOffset=function(){return this.offset},j.prototype.setFormatters=function(a){for(var b in a)a.hasOwnProperty(b)&&(this._fmt[b]=a[b])},j.prototype.render=function(){if(this.$)return this.$.root;this.$={};var a=this._renderRoot(),b=this.$.wrapper=this._renderWrapper(),c=this.$.hair=this._renderHair(),d=this.$.stopContainer=this._renderStopContainer(),e=this.$.intervalContainer=this._renderIntervalContainer(),f=this.$.rulerContainer=this._renderRulerContainer();return this.ruler=new h(this,f),a.append(b),b.append(f),b.append(e),b.append(d),b.append(c),this.$.root=a,setTimeout(this._updateViewportInfo.bind(this),100),a},j.prototype._renderRoot=function(){return $('<div class="'+s+'">')},j.prototype._renderStopContainer=function(){return $('<div class="'+A+'">')},j.prototype._renderWrapper=function(){return $('<div class="'+C+'">')},j.prototype._renderHair=function(){return $('<div class="'+D+'">')},j.prototype._renderIntervalContainer=function(){return $('<div class="'+z+'">')},j.prototype._renderRulerContainer=function(){return $('<div class="'+B+'">')},j.prototype._unselectAnyStop=function(){this._selectedStop=null},j.prototype.selectStop=function(a){this._selectedStop&&this._stopMarkerByStop(this._selectedStop).setSelected(!1),this._selectedStop=a,this._stopMarkerByStop(a).setSelected(!0)},j.prototype.getSelectedStopValue=function(){var a=this._selectedStop;return a?a.value||null:null},j.prototype.getCenter=function(){return(this.dayStart+this.dayEnd)/2|0},j.prototype.setCenter=function(a){var b=this.dayToOffset(this.getCenter()),c=this.dayToOffset(a),d=b-c;this._scrollByPx(-d)},j.prototype.getZoom=function(){return this._z},j.prototype.setZoom=function(a){if(0>a||a>H)throw new RangeError("zoom");this._z=a,this._pixelsADay=Math.pow(2,a)*I/G;var b=this.getSelectedStopValue();null===b&&(b=this.getCenter()),this._updateViewportInfo(),this._recalculatePositions(!0),this._updateWidth(),setTimeout(this.setCenter.bind(this,b),J)},j.prototype.zoomPlus=function(){var a=this.getZoom();H>a&&this.setZoom(a+1)},j.prototype.zoomMinus=function(){var a=this.getZoom();a>0&&this.setZoom(a-1)},j.prototype.offsetToDay=function(a){var b=a/this._pixelsADay,c=b+o;return 0|c},j.prototype.dayToOffset=function(a){var b=a-o,c=this._pixelsADay*b;return 0|c},j.prototype.setStateDragging=function(){console.log("STATE_DRAGGING"),this._state=r,this._stopMarkerByStop(this._selectedStop).setDragging(!0);var a=this._selectedStop.prev,b=this._selectedStop.next;this._dragMinOffset=null,this._dragMaxOffset=null,a&&(this._dragMinOffset=this.dayToOffset(a.value+1)),b&&(this._dragMaxOffset=this.dayToOffset(b.value-1)),this._dragIntervalLeft=this._selectedStop.prevInterval,this._dragIntervalRight=this._selectedStop.nextInterval},j.prototype.isStateDragging=function(){return this._state===r},j.prototype.setStateIdle=function(){console.log("STATE_IDLE"),this._state=p,this._dragIntervalLeft=null,this._dragIntervalRight=null},j.prototype.isStateIdle=function(){return this._state===p},j.prototype.setStateWaitDrag=function(){console.log("STATE_WAIT_DRAG"),this._state=q,this._waitDragTimer=setTimeout(this._onWaitDragTimeout.bind(this),K)},j.prototype.isStateWaitDrag=function(){return this._state===q},j.prototype._recalculatePositions=function(a){var b=this.model.firstStop;for(this._updateIntervalMarker(this.model._startInterval);b;){var c=this._stopMarkerByStop(b);c.setOffset(this.dayToOffset(b.value),a),this._updateIntervalMarker(b.nextInterval),b=b.next}this._updateHair()},j.prototype._scrollByPx=function(a){var b=this.$.root[0];b.scrollLeft=b.scrollLeft+a},j.prototype._getScrollPx=function(){return this.$.root[0].scrollLeft},j.prototype._getWidthPx=function(){return this.$.root[0].clientWidth},j.prototype._updateViewportInfo=function(){var a=this._getScrollPx(),b=this._getWidthPx(),c=a+b,d=this.offsetToDay(a),e=this.offsetToDay(c);this.dayStart=d,this.dayEnd=e,this._updateRuler()},j.prototype._updateWidth=function(){var a=this.dayToOffset(this.model.higherBound)+M,b=this.$.root[0].clientWidth;this.$.wrapper.css("width",Math.max(a,b))},j.prototype._updateHair=function(){var b=a(new Date),c=this.dayToOffset(b);this.$.hair.css({left:c})},j.prototype._updateRuler=function(){this.ruler.update(this.dayStart,this.dayEnd)},j.prototype._initListeners=function(){var a=this.$.root,b=$("body");a.on("click","."+y,this._onIntervalClick),a.on("mousedown","."+t,this._onStopMarkerMouseDown),a.on("dblclick","."+A,this._onStopContainerDoubleClick),a.on("dblclick","."+t,this._onStopMarkerDoubleClick),a.on("scroll",this._onRootScroll),b.on("mouseup",this._onMouseUp),b.on("mousemove",this._onMouseMove),this.model.bind("addStop",this._onAddStop),this.model.bind("removeStop",this._onRemoveStop),this.model.bind("changeStopDay",this._onChangeStopDay),this.model.bind("boundsChange",this._onBoundsChange),this.model.bind("changeInterval",this._onChangeInterval),this.model.bind("removeInterval",this._onRemoveInterval)},j.prototype._onWaitDragTimeout=function(){this.setStateDragging()},j.prototype._stopFromEvent=function(a){var b=$(a.currentTarget).attr("guid");if(!b)throw new Error("no guid in event.target");var c=this.model.stopByGuid(b);if(!c)throw new Error("stop not found");return c},j.prototype._intervalFromEvent=function(a){var b=$(a.currentTarget).attr("guid");if(!b)throw new Error("no guid in event.target");var c=this.model.intervalByGuid(b);if(!c)throw new Error("interval not found");return c},j.prototype._onStopMarkerDoubleClick=function(a){a.preventDefault();var b=this._stopFromEvent(a);this.model.removeStop(b)},j.prototype._onStopContainerDoubleClick=function(a){if(a.target===this.$.stopContainer[0]){var b=this.offsetToDay(this._localOffsetFromEvent(a));this.model.addStop(b)}},j.prototype._onStopMarkerMouseDown=function(a){a.preventDefault();var b=this._stopFromEvent(a);return this.selectStop(b),this.isStateIdle()?void this.setStateWaitDrag():void 0},j.prototype._onRootScroll=function(){this._updateViewportInfo()},j.prototype._onIntervalClick=function(a){this._intervalFromEvent(a)},j.prototype._onMouseUp=function(){return this.isStateWaitDrag()?(clearTimeout(this._waitDragTimer),void this.setStateIdle()):this.isStateDragging()?(this._onDrop(this._selectedStop),void this.setStateIdle()):void 0},j.prototype._onDrop=function(a){var b=this._stopMarkerByStop(a);b.setDragging(!1);var c=b.getOffset(),d=this.offsetToDay(c);try{this.model.changeStopDay(a,d)}catch(e){b.setOffset(this.dayToOffset(a.value))}},j.prototype._localOffsetFromEvent=function(a){var b=this.$.root,c=b[0].getBoundingClientRect(),d=c.left,e=a.clientX,f=b[0].scrollLeft;return e-d+f},j.prototype._onMouseMove=function(a){if(this.isStateDragging()){var b=this._localOffsetFromEvent(a),c=this.offsetToDay(b);return b=this.dayToOffset(c),null!==this._dragMaxOffset&&b>=this._dragMaxOffset&&(b=this._dragMaxOffset),null!==this._dragMinOffset&&b<=this._dragMinOffset&&(b=this._dragMinOffset),c=this.offsetToDay(b),this._updateStopMarker(this._stopMarkerByStop(this._selectedStop),c),this._updateIntervalMarkerStart(this._dragIntervalRight,c),void this._updateIntervalMarkerEnd(this._dragIntervalLeft,c)}},j.prototype._onAddStop=function(a){this._addStopMarker(a)},j.prototype._onRemoveStop=function(a){this._removeStopMarker(a)},j.prototype._onChangeInterval=function(a){this._updateIntervalMarker(a)},j.prototype._onRemoveInterval=function(a){this._removeIntervalMarker(a)},j.prototype._onBoundsChange=function(){this._updateWidth()},j.prototype._onChangeStopDay=function(a){var b=this.dayToOffset(a.value),c=this._stopMarkerByStop(a);c.setOffset(b)},j.prototype._removeStopMarker=function(a){var b=this._stopMarkerByStop(a);this._selectedStop===a&&this._unselectAnyStop(),b.$.remove(),this._unregisterStopMarker(b)},j.prototype._removeIntervalMarker=function(a){var b=this._intervalMarkerByInterval(a);this._unregisterIntervalMarker(a),b.$.remove()},j.prototype._updateIntervalMarkerStart=function(a,b){var c=this._intervalMarkerByInterval(a),d=this.dayToOffset(b),e=a.to?this.dayToOffset(a.to.value):1/0;c.setBounds(d,e)},j.prototype._updateIntervalMarkerEnd=function(a,b){var c=this._intervalMarkerByInterval(a),d=a.from?this.dayToOffset(a.from.value):0,e=this.dayToOffset(b);c.setBounds(d,e)},j.prototype._updateIntervalMarker=function(a,b){var c=this._intervalMarkerByInterval(a);c||(c=new l({guid:a.guid}),this.$.intervalContainer.append(c.$),this._registerIntervalMarker(c,a));var d=a.from?this.dayToOffset(a.from.value):0,e=a.to?this.dayToOffset(a.to.value):1/0;c.setBounds(d,e,b)},j.prototype._addStopMarker=function(a){var b=a.value,c=new k({guid:a.guid});this.$.stopContainer.append(c.$),this._registerStopMarker(c,a),this._updateStopMarker(c,b)},j.prototype._updateStopMarker=function(a,c){a.setOffset(this.dayToOffset(c)),a.setContent(this._fmt.stopLabel(c,b(c)))},j.prototype._stopMarkerByStop=function(a){return this._stopMarkersByGuid[a.guid]},j.prototype._intervalMarkerByInterval=function(a){return this._intervalMarkersByGuid[a.guid]},j.prototype._registerIntervalMarker=function(a,b){this._intervalMarkersByGuid[b.guid]=a},j.prototype._registerStopMarker=function(a,b){this._stopMarkersByGuid[b.guid]=a},j.prototype._unregisterIntervalMarker=function(a){delete this._intervalMarkersByGuid[a.guid]},j.prototype._unregisterStopMarker=function(a){delete this._stopMarkersByGuid[a.guid]},j.prototype.destroy=function(){this.$.off("click"),this.$.off("mousedown"),this.$.off("mouseup"),this.$.off("mousemove")},k.prototype.render=function(){var a=$('<div class="'+t+'">'),b=$('<div class="'+u+'">'),c=$('<div class="'+v+'">');return this.$content=b,a.append(c),a.append(b),a},k.prototype.setContent=function(a){this.$content.html(a)},k.prototype.setOffset=function(a,b){this.offset=a,b?this.$.animate({left:a},J):this.$.css("left",a)},k.prototype.getOffset=function(){return this.offset},k.prototype.setSelected=function(a){a&&this.$.addClass(F)||this.$.removeClass(F)},k.prototype.setDragging=function(a){a&&this.$.addClass(E)||this.$.removeClass(E)},l.prototype.setBounds=function(a,b,c){var d,e=this.$;d=c?function(a){e.animate(a,J)}:function(a){e.css(a)},d({left:a}),d(1/0===b?{width:"",right:0}:{width:b-a,right:""})},l.prototype.render=function(){return $('<div class="'+y+'">')},j}();